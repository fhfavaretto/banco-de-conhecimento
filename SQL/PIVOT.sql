SELECT 
	CODIGO,
	LOJA,
	NOME,
	CNPJ,
	TELEFONE,
	ENDERECO,
	ISNULL([201812],0) AS 'DEZ/18', 
	ISNULL([201901],0) AS 'JAN/19',
	ISNULL([201902],0) AS 'FEV/19', 
	ISNULL([201903],0) AS 'MAR/19', 
	ISNULL([201904],0) AS 'ABR/19', 
	ISNULL([201905],0) AS 'MAI/19', 
	ISNULL([201906],0) AS 'JUN/19'
FROM 
	(SELECT
		A2_COD AS CODIGO,
		A2_LOJA AS LOJA,
		A2_NREDUZ AS NOME,
		A2_CGC AS CNPJ,
		A2_TEL AS TELEFONE,
		RTRIM(LTRIM(A2_END)) + ', ' + RTRIM(LTRIM(A2_BAIRRO)) + ', ' + RTRIM(LTRIM(A2_MUN)) + ', '+ A2_EST AS ENDERECO,
		SUBSTRING(E5_DATA,1,6) AS DATA,
		SUM(E5_VALOR) AS TOTAL
	FROM
		SE2010 E2 (NOLOCK)
	INNER JOIN
		SA2010 A2 (NOLOCK)
	ON
		A2.D_E_L_E_T_ = ''
		AND A2.A2_COD = E2.E2_FORNECE
		AND A2.A2_LOJA = E2.E2_LOJA
	INNER JOIN 
		SE5010 E5 (NOLOCK)
	ON
		E5.D_E_L_E_T_ = ''
		AND E2.E2_FILIAL	= E5.E5_FILORIG
		AND E2.E2_NUM		= E5.E5_NUMERO
		AND E2.E2_PREFIXO	= E5.E5_PREFIXO
		AND E2.E2_PARCELA	= E5.E5_PARCELA
		AND E2.E2_TIPO		= E5.E5_TIPO
		AND E2.E2_FORNECE	= E5.E5_CLIFOR
		AND E2.E2_LOJA		= E5.E5_LOJA
		--AND E5.E5_MOTBX		= 'CMP'
		AND E5.E5_TIPODOC	NOT IN ('DC','MT','JR', 'ES')
		AND E5.E5_DATA		> '20181201'
		AND E5.E5_SITUACA  <> 'C'
		--AND E5.E5_CLIFOR = '00000000' 
		--AND E5.E5_LOJA = '5055'
		AND NOT EXISTS 
			(
				SELECT 
					E5_NUMERO 
				FROM 
					SE5010 SE5 (NOLOCK)
				WHERE 
					SE5.E5_FILIAL		= E5.E5_FILIAL
 					AND SE5.D_E_L_E_T_	= ''
 					AND SE5.E5_PREFIXO	= E5.E5_PREFIXO
 					AND SE5.E5_NUMERO	= E5.E5_NUMERO
 					AND SE5.E5_PARCELA	= E5.E5_PARCELA
 					AND SE5.E5_TIPO		= E5.E5_TIPO
 					AND SE5.E5_CLIFOR	= E5.E5_CLIFOR
 					AND SE5.E5_LOJA		= E5.E5_LOJA
 					AND SE5.E5_TIPODOC	IN ('ES', 'E2')
 					AND SE5.E5_SEQ		= E5.E5_SEQ
			)
	WHERE
		E2.D_E_L_E_T_ = ''
	GROUP BY
		A2_COD,
		A2_LOJA,
		A2_NREDUZ,
		A2_CGC,
		A2_TEL,
		RTRIM(LTRIM(A2_END)) + ', ' + RTRIM(LTRIM(A2_BAIRRO)) + ', ' + RTRIM(LTRIM(A2_MUN)) + ', '+ A2_EST,
		SUBSTRING(E5_DATA,1,6)
	) AS A
PIVOT
	(
		SUM(TOTAL)
		FOR DATA IN ( [201812], [201901],[201902], [201903], [201904], [201905], [201906] ) 
	) AS P

ORDER BY
	NOME